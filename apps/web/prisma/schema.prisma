generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum GlobalRole {
  USER
  ADMIN
}

enum WorkspaceRole {
  ADMIN
  EDITOR
  EMPLOYEE
  WASHER
  VIEWER
}

enum FieldType {
  TEXT
  NUMBER
  BOOLEAN
  DATE
  SELECT
  MULTISELECT
}

enum ViewType {
  GRID
  KANBAN
  CALENDAR
  LIST
}

enum AutomationRunStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ChatMessageStatus {
  PENDING
  COMPLETED
  FAILED
}

enum ChatArtifactType {
  MARKDOWN
  JSON
  TASK
  AUTOMATION
  REPORT
}

enum ThemePreference {
  DARK
  LIGHT
}

enum LocalePreference {
  EN
  EL
}

enum QuantumTheme {
  VIOLET
  CYAN
  SUNSET
}

enum ShiftStatus {
  DRAFT
  REVIEW
  PUBLISHED
  LOCKED
  COMPLETED
  CANCELLED
}

enum ShiftRequestType {
  TIME_OFF
  SWAP
  EXTRA_SHIFT
}

enum ShiftRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VehicleStatus {
  READY
  RETURNED
  NEEDS_CLEANING
  CLEANING
  QC_PENDING
  IN_SERVICE
  OUT_OF_SERVICE
}

enum VehicleEventType {
  FUEL_UPDATE
  DAMAGE_REPORT
  MAINTENANCE_NOTE
  CLEANING_NOTE
  STATUS_CHANGE
  PIPELINE_TRANSITION
  QC_PASS
  QC_FAIL
  SLA_BREACH
}

enum WasherTaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum AuthThrottleDimension {
  IP
  ACCOUNT
  DEVICE
}

model User {
  id                   String               @id @default(cuid())
  email                String               @unique
  loginName            String?              @unique
  name                 String
  passwordHash         String
  pinHash              String?
  roleGlobal           GlobalRole           @default(USER)
  themePreference      ThemePreference      @default(DARK)
  localePreference     LocalePreference     @default(EN)
  quantumTheme         QuantumTheme         @default(VIOLET)
  notificationsEnabled Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  ownedWorkspaces      Workspace[]          @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]
  notifications        Notification[]
  auditActorLogs       AuditLog[]           @relation("AuditActor")
  createdThreads       ChatThread[]         @relation("ChatThreadCreator")
  authoredMessages     ChatMessage[]        @relation("ChatMessageAuthor")
  assignedShifts       Shift[]              @relation("ShiftAssignee")
  createdShifts        Shift[]              @relation("ShiftCreator")
  lockedShifts         Shift[]              @relation("ShiftLocker")
  shiftRequests        ShiftRequest[]       @relation("ShiftRequester")
  shiftReviews         ShiftRequest[]       @relation("ShiftRequestReviewer")
  vehicleEvents        VehicleEvent[]       @relation("VehicleEventActor")
  vehicleQcSignoffs    Vehicle[]            @relation("VehicleQcSignoff")
  washerTasks          WasherTask[]         @relation("WasherTaskAssignee")
  authSessions         AuthSession[]
  inviteTokensCreated  InviteToken[]        @relation("InviteCreator")
  inviteTokensUsed     InviteToken[]        @relation("InviteConsumer")
  passwordResetTokens  PasswordResetToken[]
  shortcuts            UserShortcut[]
  actionButtons        UserActionButton[]
  promptTemplates      PromptTemplate[]
  aiUsageMeters        AiUsageMeter[]
  chatArtifacts        ChatArtifact[]
}

model Workspace {
  id            String            @id @default(cuid())
  name          String
  ownerId       String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  owner         User              @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members       WorkspaceMember[]
  tables        Table[]
  automations   Automation[]
  auditLogs     AuditLog[]
  chatThreads   ChatThread[]
  shifts        Shift[]
  shiftRequests ShiftRequest[]
  vehicles      Vehicle[]
  vehicleEvents VehicleEvent[]
  washerTasks   WasherTask[]
  inviteTokens  InviteToken[]
  shortcuts     UserShortcut[]
  actionButtons UserActionButton[]
  promptTemplates PromptTemplate[]
  aiUsageMeters  AiUsageMeter[]
  chatArtifacts  ChatArtifact[]

  @@index([ownerId])
}

model WorkspaceMember {
  workspaceId String
  userId      String
  role        WorkspaceRole
  createdAt   DateTime      @default(now())
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([workspaceId, userId])
  @@index([userId])
}

model Table {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  fields      Field[]
  records     Record[]
  views       View[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model Field {
  id          String    @id @default(cuid())
  tableId     String
  name        String
  type        FieldType
  optionsJson Json?
  position    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  table       Table     @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, name])
  @@index([tableId])
}

model Record {
  id            String   @id @default(cuid())
  tableId       String
  dataJson      Json
  searchText    String   @default("")
  openIndicator Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  table         Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([tableId, updatedAt])
  @@index([tableId, createdAt, id])
  @@index([tableId, searchText])
  @@index([tableId, openIndicator])
}

model View {
  id         String   @id @default(cuid())
  tableId    String
  name       String
  type       ViewType
  configJson Json
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  table      Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
}

model Automation {
  id          String          @id @default(cuid())
  workspaceId String
  name        String
  enabled     Boolean         @default(true)
  triggerJson Json
  actionsJson Json
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  runs        AutomationRun[]

  @@index([workspaceId])
}

model AutomationRun {
  id           String              @id @default(cuid())
  automationId String
  status       AutomationRunStatus @default(QUEUED)
  startedAt    DateTime            @default(now())
  finishedAt   DateTime?
  logsJson     Json
  automation   Automation          @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id          String    @id @default(cuid())
  workspaceId String
  actorUserId String?
  action      String
  entityType  String
  entityId    String
  metaJson    Json
  createdAt   DateTime  @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  actor       User?     @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([actorUserId])
}

model ChatThread {
  id          String        @id @default(cuid())
  workspaceId String
  title       String
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator     User          @relation("ChatThreadCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@index([workspaceId])
}

model ChatMessage {
  id             String     @id @default(cuid())
  threadId       String
  authorUserId   String?
  role           ChatRole
  content        String
  modelId        String?
  latencyMs      Int?
  tokenUsage     Int?
  status         ChatMessageStatus @default(COMPLETED)
  commandName    String?
  isPinned       Boolean    @default(false)
  attachmentUrl  String?
  attachmentMime String?
  createdAt      DateTime   @default(now())
  thread         ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author         User?      @relation("ChatMessageAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)
  artifacts      ChatArtifact[]

  @@index([threadId, createdAt])
  @@index([threadId, isPinned, createdAt])
}

model ChatArtifact {
  id           String          @id @default(cuid())
  workspaceId  String
  messageId    String?
  createdById  String?
  type         ChatArtifactType
  title        String
  content      String
  createdAt    DateTime        @default(now())
  workspace    Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  message      ChatMessage?    @relation(fields: [messageId], references: [id], onDelete: SetNull)
  creator      User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([messageId])
}

model UserShortcut {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  label       String
  command     String
  keybinding  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, userId, createdAt])
}

model UserActionButton {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  label       String
  action      String
  position    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, userId, position])
}

model PromptTemplate {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  title       String
  prompt      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, userId, createdAt])
}

model AiUsageMeter {
  id             String    @id @default(cuid())
  workspaceId    String
  userId         String?
  windowDate     DateTime
  requestsUsed   Int       @default(0)
  tokensUsed     Int       @default(0)
  provider       String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  workspace      Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, userId, windowDate, provider])
  @@index([workspaceId, windowDate])
}

model Shift {
  id             String         @id @default(cuid())
  workspaceId    String
  assignedUserId String?
  createdBy      String
  title          String
  startsAt       DateTime
  endsAt         DateTime
  status         ShiftStatus    @default(DRAFT)
  version        Int            @default(1)
  publishedAt    DateTime?
  lockedAt       DateTime?
  lockedBy       String?
  notes          String?
  snapshotJson   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  workspace      Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignee       User?          @relation("ShiftAssignee", fields: [assignedUserId], references: [id], onDelete: SetNull)
  creator        User           @relation("ShiftCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  locker         User?          @relation("ShiftLocker", fields: [lockedBy], references: [id], onDelete: SetNull)
  requests       ShiftRequest[]

  @@index([workspaceId, startsAt, endsAt])
  @@index([assignedUserId, startsAt])
}

model ShiftRequest {
  id          String             @id @default(cuid())
  workspaceId String
  requesterId String
  shiftId     String?
  type        ShiftRequestType
  status      ShiftRequestStatus @default(PENDING)
  startsAt    DateTime
  endsAt      DateTime
  reason      String
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  requester   User               @relation("ShiftRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  shift       Shift?             @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  reviewer    User?              @relation("ShiftRequestReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([workspaceId, status, createdAt])
  @@index([requesterId, createdAt])
}

model Vehicle {
  id              String         @id @default(cuid())
  workspaceId     String
  plateNumber     String
  model           String
  status          VehicleStatus  @default(READY)
  mileageKm       Int            @default(0)
  fuelPercent     Int            @default(100)
  lastServiceAt   DateTime?
  photoDataUrl    String?
  notes           String?
  slaDeadlineAt   DateTime?
  qcSignoffBy     String?
  qcResult        String?
  qcFailReason    String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  workspace       Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  events          VehicleEvent[]
  washerTasks     WasherTask[]
  qcSignoffUser   User?          @relation("VehicleQcSignoff", fields: [qcSignoffBy], references: [id], onDelete: SetNull)

  @@unique([workspaceId, plateNumber])
  @@index([workspaceId, status])
}

model VehicleEvent {
  id           String           @id @default(cuid())
  workspaceId  String
  vehicleId    String
  actorUserId  String?
  type         VehicleEventType
  valueText    String?
  valueNumber  Float?
  photoDataUrl String?
  notes        String?
  createdAt    DateTime         @default(now())
  workspace    Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  vehicle      Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  actor        User?            @relation("VehicleEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([vehicleId, createdAt])
}

model WasherTask {
  id              String           @id @default(cuid())
  workspaceId     String
  vehicleId       String
  washerUserId    String?
  status          WasherTaskStatus @default(TODO)
  exteriorDone    Boolean          @default(false)
  interiorDone    Boolean          @default(false)
  vacuumDone      Boolean          @default(false)
  notes           String?
  voiceTranscript String?
  idempotencyKey  String?
  deviceId        String?
  stationId       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  vehicle         Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  washer          User?            @relation("WasherTaskAssignee", fields: [washerUserId], references: [id], onDelete: SetNull)

  @@unique([idempotencyKey])
  @@index([workspaceId, status, createdAt])
  @@index([vehicleId, createdAt])
}

model AuthSession {
  id            String    @id @default(cuid())
  userId        String
  tokenHash     String    @unique
  userAgent     String?
  deviceId      String?
  ipAddress     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastSeenAt    DateTime  @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?
  revokedReason String?
  elevatedUntil DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt, expiresAt])
  @@index([lastSeenAt])
}

model InviteToken {
  id              String        @id @default(cuid())
  workspaceId     String
  email           String
  role            WorkspaceRole
  tokenHash       String        @unique
  invitedByUserId String
  expiresAt       DateTime
  usedAt          DateTime?
  usedByUserId    String?
  createdAt       DateTime      @default(now())
  workspace       Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy       User          @relation("InviteCreator", fields: [invitedByUserId], references: [id], onDelete: Cascade)
  usedBy          User?         @relation("InviteConsumer", fields: [usedByUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, email, usedAt])
  @@index([expiresAt])
}

model PasswordResetToken {
  id                String    @id @default(cuid())
  userId            String
  tokenHash         String    @unique
  requestedIp       String?
  requestedDeviceId String?
  requestedAgent    String?
  expiresAt         DateTime
  usedAt            DateTime?
  createdAt         DateTime  @default(now())
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt, usedAt])
}

model AuthThrottle {
  id              String                @id @default(cuid())
  dimension       AuthThrottleDimension
  identifier      String
  windowStartedAt DateTime
  attemptCount    Int                   @default(0)
  lastAttemptAt   DateTime              @default(now())
  lockoutUntil    DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@unique([dimension, identifier])
  @@index([dimension, lockoutUntil])
}

model SecurityEvent {
  id           String   @id @default(cuid())
  event        String
  severity     String   @default("info")
  requestId    String?
  actorUserId  String?
  targetUserId String?
  ipAddress    String?
  deviceId     String?
  route        String?
  detailsJson  Json
  createdAt    DateTime @default(now())

  @@index([event, createdAt])
  @@index([actorUserId, createdAt])
  @@index([targetUserId, createdAt])
}
