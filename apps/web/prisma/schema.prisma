generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum GlobalRole {
  USER
  ADMIN
}

enum WorkspaceRole {
  ADMIN
  EDITOR
  EMPLOYEE
  WASHER
  VIEWER
}

enum FieldType {
  TEXT
  NUMBER
  BOOLEAN
  DATE
  SELECT
  MULTISELECT
}

enum ViewType {
  GRID
  KANBAN
  CALENDAR
  LIST
}

enum AutomationRunStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ChatMessageStatus {
  PENDING
  COMPLETED
  FAILED
}

enum ChatArtifactType {
  MARKDOWN
  JSON
  TASK
  AUTOMATION
  REPORT
}

enum ThemePreference {
  DARK
  LIGHT
}

enum LocalePreference {
  EN
  EL
}

enum QuantumTheme {
  VIOLET
  CYAN
  SUNSET
}

enum ShiftStatus {
  DRAFT
  REVIEW
  PUBLISHED
  LOCKED
  COMPLETED
  CANCELLED
}

enum ShiftRequestType {
  TIME_OFF
  SWAP
  EXTRA_SHIFT
}

enum ShiftRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VehicleStatus {
  READY
  RETURNED
  NEEDS_CLEANING
  CLEANING
  QC_PENDING
  IN_SERVICE
  OUT_OF_SERVICE
}

enum VehicleEventType {
  FUEL_UPDATE
  DAMAGE_REPORT
  MAINTENANCE_NOTE
  CLEANING_NOTE
  STATUS_CHANGE
  PIPELINE_TRANSITION
  QC_PASS
  QC_FAIL
  SLA_BREACH
}

enum WasherTaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum AuthThrottleDimension {
  IP
  ACCOUNT
  DEVICE
}

model User {
  id                   String               @id @default(cuid())
  email                String               @unique
  loginName            String?              @unique
  name                 String
  passwordHash         String
  pinHash              String?
  roleGlobal           GlobalRole           @default(USER)
  themePreference      ThemePreference      @default(DARK)
  localePreference     LocalePreference     @default(EN)
  quantumTheme         QuantumTheme         @default(VIOLET)
  notificationsEnabled Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  ownedWorkspaces      Workspace[]          @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]
  notifications        Notification[]
  auditActorLogs       AuditLog[]           @relation("AuditActor")
  createdThreads       ChatThread[]         @relation("ChatThreadCreator")
  authoredMessages     ChatMessage[]        @relation("ChatMessageAuthor")
  assignedShifts       Shift[]              @relation("ShiftAssignee")
  createdShifts        Shift[]              @relation("ShiftCreator")
  lockedShifts         Shift[]              @relation("ShiftLocker")
  shiftRequests        ShiftRequest[]       @relation("ShiftRequester")
  shiftReviews         ShiftRequest[]       @relation("ShiftRequestReviewer")
  vehicleEvents        VehicleEvent[]       @relation("VehicleEventActor")
  vehicleQcSignoffs    Vehicle[]            @relation("VehicleQcSignoff")
  washerTasks          WasherTask[]         @relation("WasherTaskAssignee")
  authSessions         AuthSession[]
  inviteTokensCreated  InviteToken[]        @relation("InviteCreator")
  inviteTokensUsed     InviteToken[]        @relation("InviteConsumer")
  passwordResetTokens  PasswordResetToken[]
  shortcuts            UserShortcut[]
  actionButtons        UserActionButton[]
  promptTemplates      PromptTemplate[]
  aiUsageMeters        AiUsageMeter[]
  chatArtifacts        ChatArtifact[]
  attendances          Attendance[]
  userSkills           UserSkill[]
  trainingRecords      TrainingRecord[]
  handoversFrom        AssetHandover[]      @relation("AssetHandoverFrom")
  handoversTo          AssetHandover[]      @relation("AssetHandoverTo")
  reportedIncidents    Incident[]           @relation("IncidentReporter")
  automationRules      AutomationRule[]     @relation("AutomationRuleCreator")
  savedViews           SavedView[]
  runbooks             Runbook[]            @relation("RunbookCreator")
  accessReviewsGiven   AccessReview[]       @relation("AccessReviewer")
  accessReviewsReceived AccessReview[]      @relation("AccessReviewTarget")
}

model Workspace {
  id            String            @id @default(cuid())
  name          String
  ownerId       String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  owner         User              @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members       WorkspaceMember[]
  tables        Table[]
  automations   Automation[]
  auditLogs     AuditLog[]
  chatThreads   ChatThread[]
  shifts        Shift[]
  shiftRequests ShiftRequest[]
  vehicles      Vehicle[]
  vehicleEvents VehicleEvent[]
  washerTasks   WasherTask[]
  inviteTokens  InviteToken[]
  shortcuts     UserShortcut[]
  actionButtons UserActionButton[]
  promptTemplates PromptTemplate[]
  aiUsageMeters  AiUsageMeter[]
  chatArtifacts  ChatArtifact[]
  attendances    Attendance[]
  skills         Skill[]
  trainings      Training[]
  assets         Asset[]
  incidents      Incident[]
  automationRules AutomationRule[]
  savedViews     SavedView[]
  runbooks       Runbook[]
  retentionPolicies RetentionPolicy[]
  accessReviews  AccessReview[]
  stations       Station[]

  @@index([ownerId])
}

model WorkspaceMember {
  workspaceId String
  userId      String
  role        WorkspaceRole
  createdAt   DateTime      @default(now())
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([workspaceId, userId])
  @@index([userId])
}

model Table {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  fields      Field[]
  records     Record[]
  views       View[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model Field {
  id          String    @id @default(cuid())
  tableId     String
  name        String
  type        FieldType
  optionsJson Json?
  position    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  table       Table     @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, name])
  @@index([tableId])
}

model Record {
  id            String   @id @default(cuid())
  tableId       String
  dataJson      Json
  searchText    String   @default("")
  openIndicator Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  table         Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([tableId, updatedAt])
  @@index([tableId, createdAt, id])
  @@index([tableId, searchText])
  @@index([tableId, openIndicator])
}

model View {
  id         String   @id @default(cuid())
  tableId    String
  name       String
  type       ViewType
  configJson Json
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  table      Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
}

model Automation {
  id          String          @id @default(cuid())
  workspaceId String
  name        String
  enabled     Boolean         @default(true)
  triggerJson Json
  actionsJson Json
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  runs        AutomationRun[]

  @@index([workspaceId])
}

model AutomationRun {
  id           String              @id @default(cuid())
  automationId String
  status       AutomationRunStatus @default(QUEUED)
  startedAt    DateTime            @default(now())
  finishedAt   DateTime?
  logsJson     Json
  automation   Automation          @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id          String    @id @default(cuid())
  workspaceId String
  actorUserId String?
  action      String
  entityType  String
  entityId    String
  metaJson    Json
  createdAt   DateTime  @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  actor       User?     @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([actorUserId])
}

model ChatThread {
  id          String        @id @default(cuid())
  workspaceId String
  title       String
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator     User          @relation("ChatThreadCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@index([workspaceId])
}

model ChatMessage {
  id             String     @id @default(cuid())
  threadId       String
  authorUserId   String?
  role           ChatRole
  content        String
  modelId        String?
  latencyMs      Int?
  tokenUsage     Int?
  status         ChatMessageStatus @default(COMPLETED)
  commandName    String?
  isPinned       Boolean    @default(false)
  attachmentUrl  String?
  attachmentMime String?
  createdAt      DateTime   @default(now())
  thread         ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author         User?      @relation("ChatMessageAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)
  artifacts      ChatArtifact[]

  @@index([threadId, createdAt])
  @@index([threadId, isPinned, createdAt])
}

model ChatArtifact {
  id           String          @id @default(cuid())
  workspaceId  String
  messageId    String?
  createdById  String?
  type         ChatArtifactType
  title        String
  content      String
  createdAt    DateTime        @default(now())
  workspace    Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  message      ChatMessage?    @relation(fields: [messageId], references: [id], onDelete: SetNull)
  creator      User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([messageId])
}

model UserShortcut {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  label       String
  command     String
  keybinding  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, userId, createdAt])
}

model UserActionButton {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  label       String
  action      String
  position    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, userId, position])
}

model PromptTemplate {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  title       String
  prompt      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, userId, createdAt])
}

model AiUsageMeter {
  id             String    @id @default(cuid())
  workspaceId    String
  userId         String?
  windowDate     DateTime
  requestsUsed   Int       @default(0)
  tokensUsed     Int       @default(0)
  provider       String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  workspace      Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, userId, windowDate, provider])
  @@index([workspaceId, windowDate])
}

model Shift {
  id             String         @id @default(cuid())
  workspaceId    String
  assignedUserId String?
  createdBy      String
  title          String
  startsAt       DateTime
  endsAt         DateTime
  status         ShiftStatus    @default(DRAFT)
  version        Int            @default(1)
  publishedAt    DateTime?
  lockedAt       DateTime?
  lockedBy       String?
  notes          String?
  snapshotJson   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  workspace      Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignee       User?          @relation("ShiftAssignee", fields: [assignedUserId], references: [id], onDelete: SetNull)
  creator        User           @relation("ShiftCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  locker         User?          @relation("ShiftLocker", fields: [lockedBy], references: [id], onDelete: SetNull)
  requests       ShiftRequest[]

  @@index([workspaceId, startsAt, endsAt])
  @@index([assignedUserId, startsAt])
}

model ShiftRequest {
  id          String             @id @default(cuid())
  workspaceId String
  requesterId String
  shiftId     String?
  type        ShiftRequestType
  status      ShiftRequestStatus @default(PENDING)
  startsAt    DateTime
  endsAt      DateTime
  reason      String
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  requester   User               @relation("ShiftRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  shift       Shift?             @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  reviewer    User?              @relation("ShiftRequestReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([workspaceId, status, createdAt])
  @@index([requesterId, createdAt])
}

model Vehicle {
  id              String         @id @default(cuid())
  workspaceId     String
  plateNumber     String
  model           String
  status          VehicleStatus  @default(READY)
  mileageKm       Int            @default(0)
  fuelPercent     Int            @default(100)
  lastServiceAt   DateTime?
  photoDataUrl    String?
  notes           String?
  slaDeadlineAt   DateTime?
  qcSignoffBy     String?
  qcResult        String?
  qcFailReason    String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  workspace       Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  events          VehicleEvent[]
  washerTasks     WasherTask[]
  qcSignoffUser   User?          @relation("VehicleQcSignoff", fields: [qcSignoffBy], references: [id], onDelete: SetNull)
  incidents       Incident[]

  @@unique([workspaceId, plateNumber])
  @@index([workspaceId, status])
}

model VehicleEvent {
  id           String           @id @default(cuid())
  workspaceId  String
  vehicleId    String
  actorUserId  String?
  type         VehicleEventType
  valueText    String?
  valueNumber  Float?
  photoDataUrl String?
  notes        String?
  createdAt    DateTime         @default(now())
  workspace    Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  vehicle      Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  actor        User?            @relation("VehicleEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([vehicleId, createdAt])
}

model WasherTask {
  id              String           @id @default(cuid())
  workspaceId     String
  vehicleId       String
  washerUserId    String?
  status          WasherTaskStatus @default(TODO)
  exteriorDone    Boolean          @default(false)
  interiorDone    Boolean          @default(false)
  vacuumDone      Boolean          @default(false)
  notes           String?
  voiceTranscript String?
  idempotencyKey  String?
  deviceId        String?
  stationId       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  vehicle         Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  washer          User?            @relation("WasherTaskAssignee", fields: [washerUserId], references: [id], onDelete: SetNull)

  @@unique([idempotencyKey])
  @@index([workspaceId, status, createdAt])
  @@index([vehicleId, createdAt])
}

model AuthSession {
  id            String    @id @default(cuid())
  userId        String
  tokenHash     String    @unique
  userAgent     String?
  deviceId      String?
  ipAddress     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastSeenAt    DateTime  @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?
  revokedReason String?
  elevatedUntil DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt, expiresAt])
  @@index([lastSeenAt])
}

model InviteToken {
  id              String        @id @default(cuid())
  workspaceId     String
  email           String
  role            WorkspaceRole
  tokenHash       String        @unique
  invitedByUserId String
  expiresAt       DateTime
  usedAt          DateTime?
  usedByUserId    String?
  createdAt       DateTime      @default(now())
  workspace       Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy       User          @relation("InviteCreator", fields: [invitedByUserId], references: [id], onDelete: Cascade)
  usedBy          User?         @relation("InviteConsumer", fields: [usedByUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, email, usedAt])
  @@index([expiresAt])
}

model PasswordResetToken {
  id                String    @id @default(cuid())
  userId            String
  tokenHash         String    @unique
  requestedIp       String?
  requestedDeviceId String?
  requestedAgent    String?
  expiresAt         DateTime
  usedAt            DateTime?
  createdAt         DateTime  @default(now())
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt, usedAt])
}

model AuthThrottle {
  id              String                @id @default(cuid())
  dimension       AuthThrottleDimension
  identifier      String
  windowStartedAt DateTime
  attemptCount    Int                   @default(0)
  lastAttemptAt   DateTime              @default(now())
  lockoutUntil    DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@unique([dimension, identifier])
  @@index([dimension, lockoutUntil])
}

model SecurityEvent {
  id           String   @id @default(cuid())
  event        String
  severity     String   @default("info")
  requestId    String?
  actorUserId  String?
  targetUserId String?
  ipAddress    String?
  deviceId     String?
  route        String?
  detailsJson  Json
  createdAt    DateTime @default(now())

  @@index([event, createdAt])
  @@index([actorUserId, createdAt])
  @@index([targetUserId, createdAt])
}

// ─── Phase 10: Workforce Ops ─────────────────────────────────────────────────

enum AttendanceType {
  CHECK_IN
  CHECK_OUT
  BREAK_START
  BREAK_END
}

model Attendance {
  id          String         @id @default(cuid())
  workspaceId String
  userId      String
  type        AttendanceType
  recordedAt  DateTime       @default(now())
  notes       String?
  deviceId    String?
  createdAt   DateTime       @default(now())
  workspace   Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, userId, recordedAt])
}

model Skill {
  id          String        @id @default(cuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime      @default(now())
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignments UserSkill[]

  @@unique([workspaceId, name])
}

enum SkillLevel {
  BASIC
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model UserSkill {
  id        String     @id @default(cuid())
  userId    String
  skillId   String
  level     SkillLevel @default(BASIC)
  certifiedAt DateTime?
  expiresAt   DateTime?
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill     Skill      @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

model Training {
  id          String         @id @default(cuid())
  workspaceId String
  title       String
  description String?
  durationMin Int?
  createdAt   DateTime       @default(now())
  workspace   Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  records     TrainingRecord[]

  @@index([workspaceId])
}

model TrainingRecord {
  id          String         @id @default(cuid())
  trainingId  String
  userId      String
  status      TrainingStatus @default(NOT_STARTED)
  completedAt DateTime?
  expiresAt   DateTime?
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  training    Training       @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trainingId, userId])
}

// ─── Phase 10: Asset / Inventory / Keys ──────────────────────────────────────

enum AssetType {
  KEY
  EQUIPMENT
  CONSUMABLE
  ACCESSORY
}

enum AssetStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  LOST
  RETIRED
}

model Asset {
  id           String      @id @default(cuid())
  workspaceId  String
  type         AssetType
  name         String
  serialNumber String?
  status       AssetStatus @default(AVAILABLE)
  location     String?
  notes        String?
  reorderLevel Int?
  quantity     Int         @default(1)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  workspace    Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  handovers    AssetHandover[]

  @@index([workspaceId, type, status])
}

model AssetHandover {
  id         String   @id @default(cuid())
  assetId    String
  fromUserId String?
  toUserId   String?
  action     String
  notes      String?
  createdAt  DateTime @default(now())
  asset      Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  fromUser   User?    @relation("AssetHandoverFrom", fields: [fromUserId], references: [id], onDelete: SetNull)
  toUser     User?    @relation("AssetHandoverTo", fields: [toUserId], references: [id], onDelete: SetNull)

  @@index([assetId, createdAt])
}

// ─── Phase 10: Incident / Damage ─────────────────────────────────────────────

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  REPAIR_PENDING
  REPAIR_IN_PROGRESS
  RESOLVED
  CLOSED
  CLAIMED
}

model Incident {
  id           String           @id @default(cuid())
  workspaceId  String
  vehicleId    String?
  reportedBy   String
  severity     IncidentSeverity @default(MEDIUM)
  status       IncidentStatus   @default(OPEN)
  title        String
  description  String?
  photosJson   Json?
  repairEta    DateTime?
  repairCost   Float?
  claimRef     String?
  resolvedAt   DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  workspace    Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  vehicle      Vehicle?         @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  reporter     User             @relation("IncidentReporter", fields: [reportedBy], references: [id], onDelete: Cascade)

  @@index([workspaceId, status, createdAt])
  @@index([vehicleId])
}

// ─── Phase 10: Automations 2.0 ──────────────────────────────────────────────

enum AutomationRuleStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

model AutomationRule {
  id          String               @id @default(cuid())
  workspaceId String
  createdBy   String
  name        String
  description String?
  triggerJson Json
  conditionJson Json?
  actionJson  Json
  schedule    String?
  status      AutomationRuleStatus @default(ACTIVE)
  retryMax    Int                  @default(3)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  workspace   Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator     User                 @relation("AutomationRuleCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  executions  AutomationExecution[]

  @@index([workspaceId, status])
}

enum AutomationExecStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  DEAD_LETTER
}

model AutomationExecution {
  id         String              @id @default(cuid())
  ruleId     String
  status     AutomationExecStatus @default(PENDING)
  attempt    Int                 @default(1)
  inputJson  Json?
  outputJson Json?
  error      String?
  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime            @default(now())
  rule       AutomationRule      @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId, status, createdAt])
}

// ─── Phase 10: Saved Views + Runbooks ────────────────────────────────────────

model SavedView {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  name        String
  module      String
  filtersJson Json
  columnsJson Json?
  sortJson    Json?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId, userId, module])
}

model Runbook {
  id          String   @id @default(cuid())
  workspaceId String
  createdBy   String
  title       String
  content     String
  tags        String?
  pinned      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator     User      @relation("RunbookCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

// ─── Phase 10: Compliance / Retention ────────────────────────────────────────

model RetentionPolicy {
  id          String   @id @default(cuid())
  workspaceId String
  module      String
  retainDays  Int
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, module])
}

enum AccessReviewStatus {
  PENDING
  APPROVED
  REVOKED
}

model AccessReview {
  id           String             @id @default(cuid())
  workspaceId  String
  reviewerId   String
  targetUserId String
  status       AccessReviewStatus @default(PENDING)
  decision     String?
  reviewedAt   DateTime?
  createdAt    DateTime           @default(now())
  workspace    Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  reviewer     User               @relation("AccessReviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  target       User               @relation("AccessReviewTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status])
}

// ─── Phase 10: Multi-Station ─────────────────────────────────────────────────

model Station {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  code        String
  address     String?
  isActive    Boolean  @default(true)
  configJson  Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, code])
  @@index([workspaceId, isActive])
}
