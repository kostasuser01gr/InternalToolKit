generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

enum GlobalRole {
  USER
  ADMIN
}

enum WorkspaceRole {
  ADMIN
  EDITOR
  EMPLOYEE
  WASHER
  VIEWER
}

enum FieldType {
  TEXT
  NUMBER
  BOOLEAN
  DATE
  SELECT
  MULTISELECT
}

enum ViewType {
  GRID
  KANBAN
  CALENDAR
  LIST
}

enum AutomationRunStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ThemePreference {
  DARK
  LIGHT
}

enum LocalePreference {
  EN
  EL
}

enum QuantumTheme {
  VIOLET
  CYAN
  SUNSET
}

enum ShiftStatus {
  DRAFT
  PUBLISHED
  COMPLETED
  CANCELLED
}

enum ShiftRequestType {
  TIME_OFF
  SWAP
  EXTRA_SHIFT
}

enum ShiftRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VehicleStatus {
  READY
  NEEDS_CLEANING
  IN_SERVICE
  OUT_OF_SERVICE
}

enum VehicleEventType {
  FUEL_UPDATE
  DAMAGE_REPORT
  MAINTENANCE_NOTE
  CLEANING_NOTE
  STATUS_CHANGE
}

enum WasherTaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

model User {
  id                   String            @id @default(cuid())
  email                String            @unique
  loginName            String?           @unique
  name                 String
  passwordHash         String
  pinHash              String?
  roleGlobal           GlobalRole        @default(USER)
  themePreference      ThemePreference   @default(DARK)
  localePreference     LocalePreference  @default(EN)
  quantumTheme         QuantumTheme      @default(VIOLET)
  notificationsEnabled Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  ownedWorkspaces      Workspace[]       @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]
  notifications        Notification[]
  auditActorLogs       AuditLog[]        @relation("AuditActor")
  createdThreads       ChatThread[]      @relation("ChatThreadCreator")
  authoredMessages     ChatMessage[]     @relation("ChatMessageAuthor")
  assignedShifts       Shift[]           @relation("ShiftAssignee")
  createdShifts        Shift[]           @relation("ShiftCreator")
  shiftRequests        ShiftRequest[]    @relation("ShiftRequester")
  vehicleEvents        VehicleEvent[]    @relation("VehicleEventActor")
  washerTasks          WasherTask[]      @relation("WasherTaskAssignee")
}

model Workspace {
  id          String            @id @default(cuid())
  name        String
  ownerId     String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  owner       User              @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     WorkspaceMember[]
  tables      Table[]
  automations Automation[]
  auditLogs   AuditLog[]
  chatThreads ChatThread[]
  shifts      Shift[]
  shiftRequests ShiftRequest[]
  vehicles    Vehicle[]
  vehicleEvents VehicleEvent[]
  washerTasks WasherTask[]

  @@index([ownerId])
}

model WorkspaceMember {
  workspaceId String
  userId      String
  role        WorkspaceRole
  createdAt   DateTime   @default(now())
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([workspaceId, userId])
  @@index([userId])
}

model Table {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  fields      Field[]
  records     Record[]
  views       View[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model Field {
  id          String    @id @default(cuid())
  tableId     String
  name        String
  type        FieldType
  optionsJson Json?
  position    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  table       Table     @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, name])
  @@index([tableId])
}

model Record {
  id        String   @id @default(cuid())
  tableId   String
  dataJson  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  table     Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
}

model View {
  id         String   @id @default(cuid())
  tableId    String
  name       String
  type       ViewType
  configJson Json
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  table      Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
}

model Automation {
  id          String          @id @default(cuid())
  workspaceId String
  name        String
  enabled     Boolean         @default(true)
  triggerJson Json
  actionsJson Json
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  runs        AutomationRun[]

  @@index([workspaceId])
}

model AutomationRun {
  id           String              @id @default(cuid())
  automationId String
  status       AutomationRunStatus @default(QUEUED)
  startedAt    DateTime            @default(now())
  finishedAt   DateTime?
  logsJson     Json
  automation   Automation          @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id          String    @id @default(cuid())
  workspaceId String
  actorUserId String?
  action      String
  entityType  String
  entityId    String
  metaJson    Json
  createdAt   DateTime  @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  actor       User?     @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([actorUserId])
}

model ChatThread {
  id          String        @id @default(cuid())
  workspaceId String
  title       String
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator     User          @relation("ChatThreadCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@index([workspaceId])
}

model ChatMessage {
  id           String     @id @default(cuid())
  threadId      String
  authorUserId  String?
  role          ChatRole
  content       String
  attachmentUrl String?
  attachmentMime String?
  createdAt     DateTime  @default(now())
  thread        ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author        User?     @relation("ChatMessageAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)

  @@index([threadId, createdAt])
}

model Shift {
  id             String      @id @default(cuid())
  workspaceId    String
  assignedUserId String?
  createdBy      String
  title          String
  startsAt       DateTime
  endsAt         DateTime
  status         ShiftStatus @default(DRAFT)
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  workspace      Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignee       User?       @relation("ShiftAssignee", fields: [assignedUserId], references: [id], onDelete: SetNull)
  creator        User        @relation("ShiftCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  requests       ShiftRequest[]

  @@index([workspaceId, startsAt, endsAt])
  @@index([assignedUserId, startsAt])
}

model ShiftRequest {
  id          String             @id @default(cuid())
  workspaceId String
  requesterId String
  shiftId     String?
  type        ShiftRequestType
  status      ShiftRequestStatus @default(PENDING)
  startsAt    DateTime
  endsAt      DateTime
  reason      String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  requester   User               @relation("ShiftRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  shift       Shift?             @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  @@index([workspaceId, status, createdAt])
  @@index([requesterId, createdAt])
}

model Vehicle {
  id            String        @id @default(cuid())
  workspaceId   String
  plateNumber   String
  model         String
  status        VehicleStatus @default(READY)
  mileageKm     Int           @default(0)
  fuelPercent   Int           @default(100)
  lastServiceAt DateTime?
  photoDataUrl  String?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  workspace     Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  events        VehicleEvent[]
  washerTasks   WasherTask[]

  @@unique([workspaceId, plateNumber])
  @@index([workspaceId, status])
}

model VehicleEvent {
  id          String           @id @default(cuid())
  workspaceId String
  vehicleId   String
  actorUserId String?
  type        VehicleEventType
  valueText   String?
  valueNumber Float?
  photoDataUrl String?
  notes       String?
  createdAt   DateTime         @default(now())
  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  vehicle     Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  actor       User?            @relation("VehicleEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([vehicleId, createdAt])
}

model WasherTask {
  id              String           @id @default(cuid())
  workspaceId     String
  vehicleId       String
  washerUserId    String?
  status          WasherTaskStatus @default(TODO)
  exteriorDone    Boolean          @default(false)
  interiorDone    Boolean          @default(false)
  vacuumDone      Boolean          @default(false)
  notes           String?
  voiceTranscript String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  vehicle         Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  washer          User?            @relation("WasherTaskAssignee", fields: [washerUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId, status, createdAt])
  @@index([vehicleId, createdAt])
}
